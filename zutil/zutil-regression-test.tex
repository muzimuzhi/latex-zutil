\ProvidesExplFile {zutil-regression-test.tex} {2025-07-08} {0.1.0}
  {%
    Customized regression-test.tex,
    based on regression-test.tex from l3build 2025-07-03
  }

\ExplSyntaxOff
\ifnum\interactionmode>1~\scrollmode\fi
\errorcontextlines=-1 %
\showboxbreadth=\maxdimen
\showboxdepth=\maxdimen
\def\loggingoutput{%
  \tracingoutput=1 %
  \showboxbreadth=\maxdimen
  \showboxdepth=\maxdimen
}
\newlinechar=`\^^J
\ExplSyntaxOn

\cs_new_protected:Npn \LONGTYPEOUT #1
  {
    \group_begin:
      \cs_set_eq:NN \TYPE \use:n
      \test_typeout:e { #1 }
    \group_end:
  }
\cs_new_eq:NN \TYPE \LONGTYPEOUT
% #1's are curried
\cs_new_protected:Npn \test_typeout:n { \iow_term:n }
\cs_new_protected:Npn \test_typeout:e { \iow_term:e }

\str_const:Nn \STARTMESSAGE
  { This~is~a~generated~file~for~the~l3build~validation~system. }

\cs_new_protected:Npn \START
  {
    \test_typeout:n { ^^JSTART-TEST-LOG^^J }
    \test_typeout:e
      {
        ^^J
        \STARTMESSAGE
        ^^J^^JDon't~change~this~file~in~any~respect.
        ^^J^^J
      }
  }

\cs_new_protected:Npn \END
  {
    \ifnum\currentgrouplevel>0
      \test_typeout:e
        { Bad~grouping:~\the\currentgrouplevel! }
    \fi
    \ifnum\currentiflevel>1
      \test_typeout:e { Bad~conditionals:~\the\numexpr\currentiflevel-1! }
    \fi
    \test_typeout:e { ^^JEND-TEST-LOG^^J }
    \@@@end
  }
\ifx\@@end\@undefined
  \let\@@@end\end
  \let\end\END
\else
  \let\@@@end\@@end
  \let\@@end\END
\fi

\cs_new_protected:Npn \OMIT { \test_typeout:n { OMIT } }
\cs_new_protected:Npn \TIMO { \test_typeout:n { TIMO } }

\ExplSyntaxOff
\begingroup       % within the scope of this groups each line needs to end in % !
\catcode`\^^M\active %
\gdef\SHOWFILE#1{%
     \TYPE {-------- #1 (start) ---------}%
\IfFileExists{#1}%
  {\begingroup %
     \catcode`\^^M\active %
     \edef^^M{[nl]^^J}%
     \everyeof{\noexpand}%
     \obeyspaces %
     \@sanitize %
     \message{\@@input #1 }%
   \endgroup }%
  {\message{Not found}}%
     \TYPE {-------- #1 (end) -----------}%
}%
\endgroup
\ExplSyntaxOn

\file_if_exist:nT { regression-test.cfg }
  {
    \test_typeout:n
      { ^^J^^J***^^J regression-test.cfg in operation ^^J***^^J }
    \file_input:n { regression-test.cfg }
  }

\int_new:N \g_test_cnt_int

\cs_new_protected:Npn \SEPARATOR
  {
    \test_typeout:n
      { ============================================================ }
  }

\cs_new_protected:Npn \BEGINTEST #1
  {
    \int_ginc:N \g_test_cnt_int
    \SEPARATOR
    \TYPE { TEST~\int_use:N \g_test_cnt_int :~ \tl_to_str:n {#1} }
    \SEPARATOR
    \group_begin:
      \cs_set_eq:NN \TYPE \LONGTYPEOUT
  }
\cs_new_protected:Npn \ENDTEST
  {
    \group_end:
    \SEPARATOR
    \TYPE { }
  }

\cs_new_protected:Npn \TEST #1#2
  {
    \BEGINTEST {#1}
    #2
    \ENDTEST
  }
\cs_new_protected:Npn \TESTEXP #1#2
  {
    \BEGINTEST {#1}
    \TYPE {#2}
    \ENDTEST
  }

\cs_new_protected:Npn \TRUE    { \test_typeout:n { TRUE }   }
\cs_new_protected:Npn \FALSE   { \test_typeout:n { FALSE }  }
\cs_new_protected:Npn \YES     { \test_typeout:n { YES }    }
\cs_new_protected:Npn \NO      { \test_typeout:n { NO }     }
\cs_new_protected:Npn \NEWLINE { \test_typeout:n { ^^J }    }

\cs_new_protected:Npn \ASSERT #1#2
  {
    \tl_if_eq:eeTF {#1} {#2}
      { \test_typeout:n { PASSED } }
      { \test_typeout:n { FAILED } }
  }
\cs_new_protected:Npn \ASSERTSTR #1#2
  {
    \str_if_eq:eeTF {#1} {#2}
      { \test_typeout:n { PASSED } }
      { \test_typeout:n { FAILED } }
  }

\pdf_uncompress:

\ExplSyntaxOff
\ifx\pdfoutput\@undefined
  \ifx\outputmode\@undefined
  \else
    \ifnum\outputmode>0 %
      \pdfextension mapfile{pdftex.map}%
    \fi
  \fi
\else
  \ifnum\pdfoutput>0 %
    \pdfmapfile{pdftex.map}%
  \fi
\fi

\ifcsname pdfmeta_set_regression_data:\endcsname
   \csname pdfmeta_set_regression_data:\endcsname
\else
  \ifnum 0%
    \ifx\pdfoutput\@undefined\else\ifnum\pdfoutput>0 1\fi\fi
    \ifx\outputmode\@undefined\else\ifnum\outputmode>0 1\fi\fi
    >0 %
    \ifx\pdfvariable\@undefined
      \pdfinfo{/Producer (\ifx\directlua\@undefined pdf\else Lua\fi TeX)}
      \ifx\pdfinfoomitdate\@undefined\else
        \pdfinfoomitdate     = 1 %
        \pdfsuppressptexinfo = \numexpr
              0
            + 1 % PTEX.Fullbanner
            + 2 % PTEX.FileName
          \relax
        \pdftrailerid{}
      \fi
    \else
      \pdfextension info{/Producer (LuaTeX)}
      \pdfvariable suppressoptionalinfo \numexpr
            0
          +   1 % PTEX.Fullbanner
          +   2 % PTEX.FileName
          +  32 % CreationDate
          +  64 % ModDate
          + 512 % ID
        \relax
    \fi
  \else
    \ifx\XeTeXversion\@undefined
      \special{! <</DocumentUUID (DocumentUUID)>> setpagedevice}
      \special{! <</InstanceUUID (InstanceUUID)>> setpagedevice}
    \else
      \special{%
        pdf: docinfo
          <<
            /Creator        (TeX)
            /CreationDate   ()
            /ModDate        ()
            /Producer       (xdvipdfmx)
          >>
      }
    \fi
  \fi
\fi

\AddToHook{enddocument/info}[kernel/testmode]{}
\DeclareHookRule{enddocument/info}{kernel/testmode}{voids}{kernel/release}

\ExplSyntaxOn

\int_set:Nn \l_iow_line_count_int { 9999 }
