\ProvidesExplFile {zutil-regression-test.tex} {2025-07-08} {0.1.0}
  { regression-test.tex extended }

\ExplSyntaxOff
\ifnum\interactionmode>1~\scrollmode\fi
\errorcontextlines=-1 %
\showboxbreadth=\maxdimen
\showboxdepth=\maxdimen
\def\loggingoutput{%
  \tracingoutput=1 %
  \showboxbreadth=\maxdimen
  \showboxdepth=\maxdimen
}
\newlinechar=`\^^J
\ExplSyntaxOn

\cs_new_protected:Npn \LONGTYPEOUT #1
  {
    \group_begin:
      \cs_set_eq:NN \TYPE \use:n
      \iow_term:e { #1 }
    \group_end:
  }
\cs_new_eq:NN \TYPE \LONGTYPEOUT

\str_const:Nn \STARTMESSAGE
  { This~is~a~generated~file~for~the~l3build~validation~system. }

\cs_new_protected:Npn \START
  {
    \TYPE
      {
        ^^J START-TEST-LOG
        ^^J^^J \STARTMESSAGE
        ^^J^^J Don't~change~this~file~in~any~respect.
        ^^J^^J
      }
  }

\cs_new_protected:Npn \END
  {
    % As \test_end: is used after "END-TEST-LOG" is written (in \END), it's
    % too late to patch dynamically-used \test_end: to log error count. Thus
    % we have to patch \END and other commands which are \let to \END.
    %
    % Cmd hooks (i.e. "cmd/END/before") used in preamble only take effect
    % _after_ begindocument, thus are not useable here. More precisely the
    % real patchings happen in \@kernel@after@begindocument, used right
    % after the begindocument hook).
    \hook_use:n { test/enddocument }
    \ifnum\currentgrouplevel>0
      \TYPE
        { Bad~grouping:~\the\currentgrouplevel! }
    \fi
    \ifnum\currentiflevel>1
      \TYPE { Bad~conditionals:~\the\numexpr\currentiflevel-1! }
    \fi
    \TYPE { ^^JEND-TEST-LOG^^J }
    \test_end:
  }
\cs_set_eq:Nc \test_end: { @@end }
\cs_set_eq:cN { @@end } \END

\cs_new_protected:Npn \OMIT { \TYPE { OMIT } }
\cs_new_protected:Npn \TIMO { \TYPE { TIMO } }

\ExplSyntaxOff
\makeatletter
\begingroup       % within the scope of this groups each line needs to end in % !
\catcode`\^^M\active %
\gdef\SHOWFILE#1{%
     \TYPE {-------- #1 (start) ---------}%
\IfFileExists{#1}%
  {\begingroup %
     \catcode`\^^M\active %
     \edef^^M{[nl]^^J}%
     \everyeof{\noexpand}%
     \obeyspaces %
     \@sanitize %
     \message{\@@input #1 }%
   \endgroup }%
  {\message{Not found}}%
     \TYPE {-------- #1 (end) -----------}%
}%
\endgroup

\InputIfFileExists{regression-test.cfg}
  {\TYPE{^^J***^^Jregression-test.cfg in operation^^J***^^J}}{}

\makeatother
\ExplSyntaxOn

\int_new:N \g_test_cnt_int

\cs_new:Npn \SEPARATOR
  {
    \TYPE
      { ============================================================ }
  }

\cs_new_protected:Npn \BEGINTEST #1
  {
    \int_gincr:N \g_test_cnt_int
    \SEPARATOR
    \TYPE { TEST:~ \tl_to_str:n {#1} }
    \SEPARATOR
    \group_begin:
      \hook_use:n { test/TEST/begin }
      \cs_set_eq:NN \TYPE \LONGTYPEOUT
  }
\cs_new_protected:Npn \ENDTEST
  {
      \hook_use:n { test/TEST/end }
    \group_end:
    \SEPARATOR
    \TYPE { }
  }

\cs_new_protected:Npn \TEST #1#2
  {
    \BEGINTEST {#1}
    #2
    \ENDTEST
  }

\cs_new_protected:Npn \TESTEXP #1#2
  {
    \BEGINTEST {#1}
    % a group-free \LONGOUTPUT needed by local-scope \flag_raise:N
    \cs_set_eq:NN \TYPE \use:n
    \iow_term:e { #2 }
    \cs_set_eq:NN \TYPE \LONGOUTPUT
    \ENDTEST
  }

\cs_new:Npn \TRUE    { \TYPE { TRUE }   }
\cs_new:Npn \FALSE   { \TYPE { FALSE }  }
\cs_new:Npn \YES     { \TYPE { YES }    }
\cs_new:Npn \NO      { \TYPE { NO }     }
\cs_new:Npn \NEWLINE { \TYPE { ^^J }    }

\cs_new:Npn \ASSERT #1#2
  {
    \tl_if_eq:eeTF {#1} {#2}
      { \TYPE { PASSED } }
      { \TYPE { FAILED } }
  }
\cs_new:Npn \ASSERTSTR #1#2
  {
    \str_if_eq:eeTF {#1} {#2}
      { \TYPE { PASSED } }
      { \TYPE { FAILED } }
  }

\ExplSyntaxOff
\makeatletter
\ifnum 0%
  \ifx\pdfoutput\@undefined\else\ifnum\pdfoutput>0 1\fi\fi
  \ifx\outputmode\@undefined\else\ifnum\outputmode>0 1\fi\fi
  >0 %
  \ifx\pdfvariable\@undefined
    \pdfcompresslevel=0 %
    \pdfobjcompresslevel=0 %
  \else
    \pdfvariable compresslevel=0 %
    \pdfvariable objcompresslevel=0 %
  \fi
\else
  \ifx\XeTeXversion\@undefined
  \special{%
      ps: /setdistillerparams
      where
        {pop << /CompressPages false /CompressStreams false >> setdistillerparams}% noqa: s103
      if
    }%
  \else
    \special{dvipdfmx:config z 0}% Compress level
    \special{dvipdfmx:config C 0x40}% Object compression
  \fi
\fi

\ifx\pdfoutput\@undefined
  \ifx\outputmode\@undefined
  \else
    \ifnum\outputmode>0 %
      \pdfextension mapfile{pdftex.map}%
    \fi
  \fi
\else
  \ifnum\pdfoutput>0 %
    \pdfmapfile{pdftex.map}%
  \fi
\fi

\ifcsname pdfmeta_set_regression_data:\endcsname
   \csname pdfmeta_set_regression_data:\endcsname
\else
  \ifnum 0%
    \ifx\pdfoutput\@undefined\else\ifnum\pdfoutput>0 1\fi\fi
    \ifx\outputmode\@undefined\else\ifnum\outputmode>0 1\fi\fi
    >0 %
    \ifx\pdfvariable\@undefined
      \pdfinfo{/Producer (\ifx\directlua\@undefined pdf\else Lua\fi TeX)}
      \ifx\pdfinfoomitdate\@undefined\else
        \pdfinfoomitdate     = 1 %
        \pdfsuppressptexinfo = \numexpr
              0
            + 1 % PTEX.Fullbanner
            + 2 % PTEX.FileName
          \relax
        \pdftrailerid{}
      \fi
    \else
      \pdfextension info{/Producer (LuaTeX)}
      \pdfvariable suppressoptionalinfo \numexpr
            0
          +   1 % PTEX.Fullbanner
          +   2 % PTEX.FileName
          +  32 % CreationDate
          +  64 % ModDate
          + 512 % ID
        \relax
    \fi
  \else
    \ifx\XeTeXversion\@undefined
      \special{! <</DocumentUUID (DocumentUUID)>> setpagedevice}
      \special{! <</InstanceUUID (InstanceUUID)>> setpagedevice}
    \else
      \special{%
        pdf: docinfo
          <<
            /Creator        (TeX)
            /CreationDate   ()
            /ModDate        ()
            /Producer       (xdvipdfmx)
          >>
      }
    \fi
  \fi
\fi

\AddToHook{enddocument/info}[kernel/testmode]{}
\DeclareHookRule{enddocument/info}{kernel/testmode}{voids}{kernel/release}

\makeatother
\ExplSyntaxOn

\int_set:Nn \l_iow_line_count_int { 9999 }
