\ProvidesExplPackage {zutil} {2025-12-02} {0.7.0}
  {Z's utilities}

% shared temp variables
\tl_new:N    \l__zutil_tmp_tl
\str_new:N   \l__zutil_tmp_str  % noqa: W415

% variable(s)
\str_new:N   \l__zutil_presets_str

% shared message for raising short and one-time messages
\msg_new:nnn { zutil } { _shared } { #1 }

% version guard
\cs_set_protected:Npn \__zutil_tmp:w #1
  {
    \IfExplAtLeastF{#1}
      {
        \msg_critical:nne { zutil } { _shared }
          {
            Need~l3kernel~#1~or~later.~ Got~\ExplLoaderFileDate.
          }
      }
  }
\__zutil_tmp:w { 2025-10-09 } % required by \l_keys_choice_str

% package options
\DeclareKeys [ zutil ]
  {
    presets .choices:nn =
      { none, util, test, debug, all }
      {
        \str_set_eq:NN \l__zutil_presets_str \l_keys_choice_str
      }
  , presets .value_required:n = true
  , presets .usage:n    = load
  , presets .initial:n  = util
  }

% option "presets" internals
\cs_new_protected:Npn \__zutil_use_presets_none: { }
\cs_new_protected:Npn \__zutil_use_presets_util:
  {
    \zutil_load_module:n { l3extras }
    \zutil_load_module:n { l3patch }
  }
\cs_new_protected:Npn \__zutil_use_presets_test:
  {
    \__zutil_use_presets_util:
    \zutil_load_module:n { softerror }
  }
\cs_new_protected:Npn \__zutil_use_presets_debug:
  {
    \zutil_load_module:n { debug }
    \zutil_load_module:n { unravel }
  }
\cs_new_protected:Npn \__zutil_use_presets_all:
  {
    \zutil_load_module:n { l3extras }
    \zutil_load_module:n { l3patch }
    \zutil_load_module:n { softerror }
    \zutil_load_module:n { debug }
    \zutil_load_module:n { unravel }
  }

% module loading

% #1 is curried
\cs_new_protected:Npn \zutil_set:n
  {
    \keys_set:nn { zutil }
  }

\cs_new_protected:Npn \zutil_load_module:n #1
  {
    \int_compare:nNnTF { \currentgrouplevel } > { 0 }
      {
        \msg_error:nne { zutil } { _shared }
          {
            Loading~module~'#1'~in~a~group.~
            Modules~should~be~loaded~at~the~top~level.
          }
      }
      {
        \exp_args:Ne \__zutil_load_module_aux:n { \tl_to_str:e { #1 } }
      }
  }

\cs_new_protected:Npn \__zutil_load_module_aux:n #1
  {
    \cs_if_exist:cF { __zutil_module_[#1]_loaded: }
      {
        \cs_gset:cn { __zutil_module_[#1]_loaded: } {}
        % learned from how tcolorbox loads its libraries
        %
        % \@pushfilename records current states of \makeat(letter|other)
        % and \ExplSyntax(On|Off), and \@popfilename restores them.
        % This way, \zutil_load_module:n can be used in any category code
        % schemes.
        %
        % \makeatletter and \ExplSyntaxOff set initial category code
        % scheme for modules, especially for the description arg of
        % \ProvidesExplFile.
        \@pushfilename
        \xdef\@currname{zutil-#1.code.tex}  % noqa: s204
        \makeatletter
        \ExplSyntaxOff
        % \file_input:n doesn't use file hooks
        \InputIfFileExists{\@currname}{}{  % noqa: s204
          \msg_error:nne { zutil } { _shared }
            { Unknown~module~'#1'.~ File~'\@currname'~not~found. }
        }
        \@popfilename
      }
  }
% infected by preamble-only \@pushfilename and \@popfilename
% explcheck: the next line causes "W302 unbraced n-type function call argument"
\@onlypreamble \zutil_load_module:n

% process package options
% initially, "presets=util" is set
\ProcessKeyOptions [ zutil ]  % noqa: w302

\use:c { __zutil_use_presets_ \l__zutil_presets_str : }
